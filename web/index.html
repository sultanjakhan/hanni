<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hanni Chat</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', system-ui, sans-serif;
  background: #0a0a0a;
  color: #e0e0e0;
  height: 100dvh;
  display: flex;
  flex-direction: column;
}

.header {
  padding: 16px 20px;
  background: #111;
  border-bottom: 1px solid #222;
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  color: #fff;
}

.header span { color: #888; font-weight: 400; font-size: 13px; margin-left: 8px; }

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 16px;
  line-height: 1.5;
  font-size: 15px;
  white-space: pre-wrap;
  word-break: break-word;
}

.msg.user {
  align-self: flex-end;
  background: #2563eb;
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg.bot {
  align-self: flex-start;
  background: #1e1e1e;
  color: #e0e0e0;
  border-bottom-left-radius: 4px;
}

.msg.bot .cursor {
  display: inline-block;
  width: 2px;
  height: 16px;
  background: #2563eb;
  margin-left: 2px;
  vertical-align: text-bottom;
  animation: blink 0.6s infinite;
}

@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

.timing {
  font-size: 11px;
  color: #555;
  margin-top: 4px;
  align-self: flex-start;
}

#input-area {
  padding: 12px 16px;
  background: #111;
  border-top: 1px solid #222;
  display: flex;
  gap: 10px;
}

#input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 20px;
  border: 1px solid #333;
  background: #1a1a1a;
  color: #fff;
  font-size: 15px;
  outline: none;
  font-family: inherit;
}

#input:focus { border-color: #2563eb; }

#send {
  padding: 10px 20px;
  border-radius: 20px;
  border: none;
  background: #2563eb;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  font-weight: 500;
}

#send:disabled { opacity: 0.4; cursor: not-allowed; }
#send:hover:not(:disabled) { background: #1d4ed8; }
</style>
</head>
<body>

<div class="header">Hanni <span>Qwen3 30B · MLX · local</span></div>

<div id="chat"></div>

<div id="input-area">
  <input id="input" type="text" placeholder="Напиши сообщение..." autocomplete="off">
  <button id="send">→</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const sessionId = crypto.randomUUID();
let busy = false;

function scrollDown() {
  chat.scrollTop = chat.scrollHeight;
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = text;
  chat.appendChild(div);
  scrollDown();
  return div;
}

async function send() {
  const text = input.value.trim();
  if (!text || busy) return;

  busy = true;
  sendBtn.disabled = true;
  input.value = '';

  addMsg('user', text);

  const botDiv = document.createElement('div');
  botDiv.className = 'msg bot';
  const cursor = document.createElement('span');
  cursor.className = 'cursor';
  botDiv.appendChild(cursor);
  chat.appendChild(botDiv);
  scrollDown();

  const t0 = performance.now();
  let firstToken = 0;
  let tokens = 0;

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, session_id: sessionId }),
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const payload = line.slice(6);
        if (payload === '[DONE]') continue;

        try {
          const { token } = JSON.parse(payload);
          if (token) {
            if (!firstToken) firstToken = performance.now() - t0;
            tokens++;
            botDiv.insertBefore(document.createTextNode(token), cursor);
            scrollDown();
          }
        } catch {}
      }
    }
  } catch (e) {
    botDiv.textContent = '⚠ Ошибка подключения к MLX серверу';
  }

  cursor.remove();
  const total = ((performance.now() - t0) / 1000).toFixed(1);
  const ttft = firstToken ? (firstToken / 1000).toFixed(1) : '?';

  const timing = document.createElement('div');
  timing.className = 'timing';
  timing.textContent = `${ttft}s до первого токена · ${total}s всего · ${tokens} токенов`;
  chat.appendChild(timing);
  scrollDown();

  busy = false;
  sendBtn.disabled = false;
  input.focus();
}

sendBtn.addEventListener('click', send);
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

input.focus();
</script>
</body>
</html>
